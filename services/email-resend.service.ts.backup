/**
 * Email Service using EmailJS
 * Handles all email communications:
 * 1. Notify sales when website is generated
 * 2. Send credentials to user
 * 3. Notify user when site is published
 */

import emailjs from '@emailjs/nodejs';

// EmailJS Configuration
const EMAILJS_SERVICE_ID = process.env.EMAILJS_SERVICE_ID || '';
const EMAILJS_PUBLIC_KEY = process.env.EMAILJS_PUBLIC_KEY || '';
const EMAILJS_PRIVATE_KEY = process.env.EMAILJS_PRIVATE_KEY || '';

const SALES_EMAIL = process.env.SALES_EMAIL || 'sales@yourcompany.com';

export interface SendToSalesParams {
  businessName: string;
  customerEmail: string;
  customerPhone?: string;
  liveUrl: string;
  submissionId: string;
  username: string;
  password: string;
}

export interface SendCredentialsToUserParams {
  businessName: string;
  customerEmail: string;
  customerName?: string;
  username: string;
  password: string;
  liveUrl: string;
  loginUrl: string;
}

export interface SendPublishedNotificationParams {
  businessName: string;
  customerEmail: string;
  customerName?: string;
  liveUrl: string;
}

class EmailService {
  /**
   * Send notification to sales team when website is generated
   */
  async sendToSales(params: SendToSalesParams) {
    const {
      businessName,
      customerEmail,
      customerPhone,
      liveUrl,
      submissionId,
      username,
      password,
    } = params;

    const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Website Generated - ${businessName}</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
    <h1 style="color: white; margin: 0; font-size: 24px;">ğŸ‰ New Website Generated!</h1>
  </div>
  
  <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; border: 1px solid #e9ecef;">
    <h2 style="color: #667eea; margin-top: 0;">Business Details</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <tr>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;"><strong>Business Name:</strong></td>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">${businessName}</td>
      </tr>
      <tr>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;"><strong>Customer Email:</strong></td>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">${customerEmail}</td>
      </tr>
      ${customerPhone ? `
      <tr>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;"><strong>Phone:</strong></td>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">${customerPhone}</td>
      </tr>
      ` : ''}
      <tr>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef;"><strong>Submission ID:</strong></td>
        <td style="padding: 10px 0; border-bottom: 1px solid #e9ecef; font-family: monospace; font-size: 12px;">${submissionId}</td>
      </tr>
    </table>

    <h2 style="color: #667eea; margin-top: 30px;">ğŸ”‘ Login Credentials</h2>
    <div style="background: #fff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin: 15px 0;">
      <p style="margin: 5px 0;"><strong>Username:</strong> <code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px;">${username}</code></p>
      <p style="margin: 5px 0;"><strong>Password:</strong> <code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px;">${password}</code></p>
    </div>

    <h2 style="color: #667eea; margin-top: 30px;">ğŸŒ Live Website</h2>
    <div style="text-align: center; margin: 20px 0;">
      <a href="${liveUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;">View Live Website â†’</a>
    </div>
    <p style="text-align: center; font-size: 14px; color: #666;">
      <a href="${liveUrl}" style="color: #667eea; text-decoration: none;">${liveUrl}</a>
    </p>

    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 30px;">
      <p style="margin: 0; color: #856404;"><strong>âš¡ Next Steps:</strong></p>
      <ol style="margin: 10px 0 0 0; color: #856404;">
        <li>Review the generated website</li>
        <li>Send credentials to customer using the dashboard</li>
        <li>Follow up with customer for feedback</li>
      </ol>
    </div>
  </div>

  <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
    <p>This is an automated notification from AI Website Builder</p>
  </div>
</body>
</html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: SALES_EMAIL,
        subject: `ğŸ‰ New Website Generated - ${businessName}`,
        html,
      });

      console.log('âœ… Sales notification email sent:', result);
      return result;
    } catch (error) {
      console.error('âŒ Failed to send sales notification:', error);
      throw error;
    }
  }

  /**
   * Send login credentials to customer
   */
  async sendCredentialsToUser(params: SendCredentialsToUserParams) {
    const {
      businessName,
      customerEmail,
      customerName,
      username,
      password,
      liveUrl,
      loginUrl,
    } = params;

    const displayName = customerName || businessName;

    const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Website is Ready - ${businessName}</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; border-radius: 10px 10px 0 0; text-align: center;">
    <h1 style="color: white; margin: 0; font-size: 28px;">ğŸ‰ Your Website is Ready!</h1>
    <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;">We've created a beautiful website for ${businessName}</p>
  </div>
  
  <div style="background: #ffffff; padding: 30px; border: 1px solid #e9ecef;">
    <p style="font-size: 16px; margin-top: 0;">Hi ${displayName},</p>
    
    <p style="font-size: 16px;">Great news! Your professional website has been generated and is now live. You can access and manage your website using the credentials below.</p>

    <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">ğŸ” Your Login Credentials</h2>
    <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; border-left: 4px solid #667eea; margin: 20px 0;">
      <p style="margin: 0 0 15px 0;"><strong style="color: #495057;">Username:</strong></p>
      <p style="margin: 0 0 20px 0; background: white; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 16px; border: 1px solid #dee2e6;">${username}</p>
      
      <p style="margin: 0 0 15px 0;"><strong style="color: #495057;">Password:</strong></p>
      <p style="margin: 0; background: white; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 16px; border: 1px solid #dee2e6;">${password}</p>
    </div>

    <div style="background: #e7f3ff; border: 1px solid #2196F3; padding: 15px; border-radius: 8px; margin: 25px 0;">
      <p style="margin: 0; color: #0d47a1; font-size: 14px;">ğŸ’¡ <strong>Pro Tip:</strong> We recommend changing your password after your first login for enhanced security.</p>
    </div>

    <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">ğŸš€ Access Your Website</h2>
    <div style="text-align: center; margin: 25px 0;">
      <a href="${loginUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 50px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 18px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">Login to Dashboard â†’</a>
    </div>

    <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">ğŸŒ Your Live Website</h2>
    <p style="font-size: 16px;">Your website is already live and accessible to the world:</p>
    <div style="text-align: center; margin: 20px 0;">
      <a href="${liveUrl}" style="display: inline-block; background: #28a745; color: white; padding: 14px 40px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;">View Live Website â†’</a>
    </div>
    <p style="text-align: center; font-size: 14px; color: #666; margin: 10px 0;">
      <a href="${liveUrl}" style="color: #667eea; text-decoration: none; word-break: break-all;">${liveUrl}</a>
    </p>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #e9ecef;">
      <p style="margin: 0 0 10px 0; color: #495057; font-weight: bold;">Need Help?</p>
      <p style="margin: 0; color: #6c757d; font-size: 14px;">If you have any questions or need assistance, feel free to reply to this email. We're here to help!</p>
    </div>
  </div>

  <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; text-align: center; color: #6c757d; font-size: 14px; border: 1px solid #e9ecef; border-top: none;">
    <p style="margin: 0;">Best regards,<br><strong>AI Website Builder Team</strong></p>
  </div>

  <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
    <p style="margin: 0;">You're receiving this email because you requested a website from AI Website Builder</p>
  </div>
</body>
</html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: customerEmail,
        subject: `ğŸ‰ Your Website is Ready - ${businessName}`,
        html,
      });

      console.log('âœ… Credentials email sent to user:', result);
      return result;
    } catch (error) {
      console.error('âŒ Failed to send credentials email:', error);
      throw error;
    }
  }

  /**
   * Send notification when website is published
   */
  async sendPublishedNotification(params: SendPublishedNotificationParams) {
    const { businessName, customerEmail, customerName, liveUrl } = params;

    const displayName = customerName || businessName;

    const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Website Published - ${businessName}</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
  <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 40px 30px; border-radius: 10px 10px 0 0; text-align: center;">
    <h1 style="color: white; margin: 0; font-size: 28px;">ğŸš€ Your Website is Live!</h1>
    <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 16px;">${businessName} is now online</p>
  </div>
  
  <div style="background: #ffffff; padding: 30px; border: 1px solid #e9ecef;">
    <p style="font-size: 16px; margin-top: 0;">Hi ${displayName},</p>
    
    <p style="font-size: 16px;">Congratulations! Your website has been published and is now live on the internet. ğŸ‰</p>

    <div style="text-align: center; margin: 30px 0;">
      <a href="${liveUrl}" style="display: inline-block; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 18px 50px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 18px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);">Visit Your Website â†’</a>
    </div>

    <p style="text-align: center; font-size: 14px; color: #666; margin: 20px 0;">
      <a href="${liveUrl}" style="color: #28a745; text-decoration: none; word-break: break-all;">${liveUrl}</a>
    </p>

    <div style="background: #d4edda; border: 1px solid #28a745; padding: 20px; border-radius: 8px; margin: 30px 0;">
      <p style="margin: 0 0 15px 0; color: #155724; font-weight: bold;">âœ¨ What's Next?</p>
      <ul style="margin: 0; padding-left: 20px; color: #155724;">
        <li>Share your website link with customers and on social media</li>
        <li>Monitor your website traffic in the dashboard</li>
        <li>Request changes or updates anytime</li>
      </ul>
    </div>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px; border: 1px solid #e9ecef;">
      <p style="margin: 0 0 10px 0; color: #495057; font-weight: bold;">Need Support?</p>
      <p style="margin: 0; color: #6c757d; font-size: 14px;">Our team is here to help. Reply to this email with any questions or feedback!</p>
    </div>
  </div>

  <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; text-align: center; color: #6c757d; font-size: 14px; border: 1px solid #e9ecef; border-top: none;">
    <p style="margin: 0;">Best regards,<br><strong>AI Website Builder Team</strong></p>
  </div>
</body>
</html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: customerEmail,
        subject: `ğŸš€ ${businessName} is Now Live!`,
        html,
      });

      console.log('âœ… Published notification sent to user:', result);
      return result;
    } catch (error) {
      console.error('âŒ Failed to send published notification:', error);
      throw error;
    }
  }
}

export const emailService = new EmailService();
